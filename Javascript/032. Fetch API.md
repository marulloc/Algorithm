# Fetch

### 1. Fetch는 API다.

따라서, ECMAScript 스펙에 없다. API는 일반적으로 `new`키워드를 사용하여 인스턴스를 생성하지만, Fetch API는 `fetch()` 형태로 호출한다.

### 2. **비동기 환경**에서 **비동기로 통신**을 한다.

### 3. XMLHttpRequest와 비슷하지만, CORS, HTTP 관련을 망라하여 지원한다.

### 4. 통신에 성공하면 **Promise를 반환**한다.

```javascript
const url = "../../image/something.png";
fetch(url)
  .then((response) => {
    return response.blob();
  })
  .then((blob) => {
    const el = document.querySelector("img");
    el.src = URL.createObjectUrl(blob);
  });
```

1. `fetch(url)`로 파라미터에 작성한 URL의 "something.png"파일을 비동기로 가져온다.
2. 파일 수신이 성공적으로 끝나면, `then()`의 첫 번째 파라미터 핸들러 함수가 실행되며, fetch가 반환한 Promise 인스턴스가, 핸들러 함수의 파라미터 "response"로 맵핑되어 넘어간다.
3. `blob()` 메소드로, response 안에 있는 **Blob Object를 추출**하고, Promise 인스턴스를 생성한 후 다음 .then이 호출된다.
   - **then이 진짜 반환하는 것은 `return`문의 표현식이 아니라 Promise 인스턴스다.**
   - **`return` 표현식에 달린 것은 다음 then의 핸들러 함수의 인자에 맵핑된다.**
4. 두 번째 `.then((blob)=>{...})`가 실행된다.
   - blob는 상위 then의 return문으로 넘긴 것이 된다.

### 5. fetch()가 비동기 환경에서 실행되므로, `async/await`를 사용할 수 있다.

```javascript
async function getImage(url) {
  const response = await fetch(url);
  return response.blob();
}

const url = "../../image/something.png";
getImage(url).then((blob) => {
  const el = document.querySelector("img");
  el.src = URL.createObjectURL(blob);
});
```

- async 함수 안에 `await fetch(url)`이 작성되어 있다.
- await 키워드에 의해, 이미지 정보를 다 받을 때 까지, 아래이 있는 코드가 실행되지 않는다.

1. `await fetch(url)`에서, 서버의 응답을 받을 때 까지 대기한다.
   - async함수는 따로 실행자가 없다. 응답을 받으면, 내부적으로 resolve함수가 호출된 것으로 동작한다.
   - return 의 표현식은 resolve나 reject(성공/실패)함수의 파라미터로 맵핑된다.
2. async가 성공적이었으면, then의 첫 번째 파라미터 핸들러가 동작하고, 반대의 경우 두 번째 파라미터 핸들러가 동작한다.

### `await`는 비동기 환경에서 동기적으로 동작하며, `then()`은 비동기 환경에서 비동기적으로 동작한다.

<hr>
<br>
<br>

## Fetch API 구성

Fetch API의 구성은 다음과 같다.

1. HTTP REQUEST
2. HTTP RESPONSE
3. HEADERS
4. BODY

- fetch API 는 **Window와 WorkerGlobalScope**에서 인스턴스를 생성하지 않고 `fetch()`와 같이 직접 호출해서 사용한다.
- `fetch(url, option)` 으로 사용된다. 첫 번째 인자는 요청을 보낼 url이며, 두 번째 인자는 요청에 있어서 사용할 **통신 옵션**이다.

<hr>
<br>
<br>

## Fetch Request Object

- Request 인스턴스를 생성하고 반환한다.

```javascript
async function getImage(url) {
  const obj = new Request(url, { method: "GET" });
  console.log(obj.url);
  console.log(obj.method);
  const response = await fetch(obj);
  return response.blob();
}

getImage(url).then((blob) => {
  const el = document.querySelector("img");
  el.src = URL.createObjectUrl(blob);
});
```

- `new Request(url, option)`으로 Request 객체를 생성한다.
- 옵션을 작성하지 않으면 디폴트 값으로 설정된다.

<br>

### Request 옵션

Request Object의 옵션은 다음과 같다.

- Read Only가 아닌 것은 Request 객체에 옵션으로 설정할 수 있다.

1. **method**
   - Request Method(GET, POST)등이 담기는 곳
2. **body**
   - 서버로 보낼 데이터(문자열, FormData, Blob) 등을 작성하는 프로퍼티
3. **keepalive**
   - 웹 페이지보다 Request가 더 길게 존속하려고 할 때 사용한다.
4. **cache**
   - Request의 cache 모드
5. **credentials**
   - Request의 인증 정보, 쿠키 사용 관련
6. **headers**
   - Request의 headers 오브젝트가 설정되는 곳
7. **mode**
   - Request 모드, same-origin, cors 설정
8. **redirect**
   - redirect 취급 방법
9. **referrer**
   - 현재 페이지를 링크한 이전 address를 담음
10. **referrerPolicy**
    - Request에 referre 정보를 포함하는 기준
11. **signal**
    - AbortSignal 오브젝트, Abort 제어
12. **intergrity**
    - 브라우저가 체크하는 보안 기능, 서브 리소스 정합성(SRI)값이 담긴다.
13. **destination** (Read Only)
    - Request 리소스 타입, image, worker
14. **isReloadNavigation** (Read Only)
    - 리로드 네비게이션 Request인지의 여부가 담긴다.
15. **isHistoryNavigation** (Read Only)
    - 히스토리 네비게이션 Request인지의 여부가 담긴다.

```javascript
const obj = new Request(url);

console.log(obj.body); //=> undefined
console.log(obj.cache); //=> default
console.log(obj.credentials); //=> same-origin
console.log(obj.headers); //=> { }
console.log(obj.intergrity); //=> ""
console.log(obj.destination); //=> empty
console.log(obj.isReloadNavigation); //=> undefined
console.log(obj.isHistoryNavigation); //=> false
```

<hr>
<br>
<br>
